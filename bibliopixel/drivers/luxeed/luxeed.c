//only used at the beginning of the program
unsigned char startData[64] = {0xfb,0xbf,0xf1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                                 0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                                0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                               0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0};

//holds the data for all of the colors
unsigned char colors[207] = {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                             0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                 0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0};

//colors data is copied into this array
unsigned char data[256] = {0xfa,0xaf,0xf1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                        0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                           0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                        0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                        0xfa,0xaf,0xf1,0x01,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                        0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                        0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                       0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                       0xfa,0xaf,0xf1,0x02,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                       0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                                0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                       0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                          0xfa,0xaf,0xf1,0x03,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                              0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                           0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
                       0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x02,0x01,0xff};

unsigned char* redStart = colors; //the start of the red data
unsigned char* greenStart = colors + 69; //the start of the green data
unsigned char* blueStart = colors + 138; //the start of the blue data
unsigned char* message1Start = data; //start of each of the messages
unsigned char* message2Start = data + 64;
unsigned char* message3Start = data + 128;
unsigned char* message4Start = data + 192;

key keys[69];   //an array with a key struct for each key (later used for more advanced controls)
char asciiCodes[138]; //the ascii codes for the keys in order
int errorCode; //the variable used for error codes
int debugCode = 0;

struct libusb_device *device;
struct libusb_device_handle *handle = NULL;



///sends a message to the device with the handle, the data to be send, the control in the data, and the index
int sendMessage(libusb_device_handle *handle , unsigned char* data)
{
    int code; //return code for the write
    int trans;
    // http://libusb.sourceforge.net/api-1.0/group__syncio.html#gab8ae853ab492c22d707241dc26c8a805

    //                                  endpoint    length
    code = libusb_bulk_transfer(handle, 0x03, data, 64, &trans, 1000); //sends the data
    if(debugCode >= 1)
    {
        printf("%d bytes of data written to the keyboard\n", trans);
    }
    return code;
}


int lux_update()
{
    int i;
    memcpy(message1Start + 4,colors,60);        //copys the first 60 bytes of the colors array into the data array in the 1st message
    memcpy(message2Start + 4,colors + 60,60);   //the next 60 bytes are copied in data completeing message 2
    memcpy(message3Start + 4,colors + 120,60); //then the next 60
    memcpy(message4Start + 4,colors + 180,27); //only 27 are needed because that is the rest of the colors array

    for(i = 0; i < 4;i++)
    {
        errorCode = sendMessage(handle, data + (64 * i)); //the 64 * i is added to increment the part of the data being sent
        if(debugCode >=1)
        {
            printf("usb bulk transfer code: %d\n",errorCode);
        }
    }

    return 0;
}

void lux_setKey(int keyNum, int red, int green, int blue)
{
    if(keyNum >= 0 && keyNum < 69) //bounds checking
    {
        *(redStart + keyNum) = red;
        *(blueStart + keyNum) = blue;
        *(greenStart + keyNum) = green;
    }
}

int lux_setKeyAscii(char code, int red, int green, int blue)
{
    int found = 0;
    int i = 0;
    if(code != 0x20)
    {
        while(found == 0)
        {
            if(keys[i].ascii[0] == code || keys[i].ascii[1] == code)
            {
                found = 1;
                *(redStart + i) = red;
                        *(blueStart + i) = blue;
                        *(greenStart + i) = green;
            }

            i++;
            if(i >= 69)
            {
                found = -1;
            }
        }
    }
    return found;
}

void lux_setAll(int red, int green, int blue)
{
    int i;
    for(i = 0; i < 69; i++)
    {
        lux_setKey(i, red, green, blue);
    }
}


int lux_initialize() //initilizes the device(Find,Open,Claim)
{
    sendMessage(handle, startData); //sends the start message to the keyboard
    strcpy(asciiCodes,"`~1!2@3#4$5%6^7&8*9(0)-_=+              QqWwEeRrTtYyUuIiOoPp{[}]|\\  AaSsDdFfGgHhJjKkLl:; '    ZzXxCcVvBbNnMm<,>.?/                        ");  //if there is a space no ascii value exists
    return 0;
}
